<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Dashboard de Hábitos y Crecimiento</title>
  <link rel="stylesheet" href="../css/habitos.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
    rel="stylesheet" />
  <script src="../js/api.js"></script>
</head>

<body class="habitos-page">
  <div class="habitos-container">
    <!-- Main Content Area -->
    <main class="habitos-main">
      <div class="habitos-header">
        <h1 class="habitos-header__title">Tus Hábitos</h1>
        <div class="habitos-header__actions">
          <a href="calendario.html" class="habitos-header__button">
            <span class="material-symbols-outlined">calendar_today</span>
          </a>
        </div>
      </div>

      <!-- Header / Tree Landscape Section -->
      <!-- Habits List Section -->
      <!-- Tree Visual Section -->
      <div class="habitos-tree-section">
        <!-- Tree Placeholder/Visual -->
        <div class="habitos-tree-visual">
          <div class="habitos-tree-icon-container">
            <!-- This represents the tree/growth visual mentioned -->
            <span class="material-symbols-outlined habitos-tree-icon">park</span>
            <div class="habitos-tree-badge">
              <span class="material-symbols-outlined habitos-tree-badge-icon">eco</span>
            </div>
          </div>
        </div>

        <!-- Level Indicator Overlay -->
        <div class="habitos-level-container">
          <div class="habitos-level-card">
            <p class="habitos-level-label">Nivel Actual</p>
            <p class="habitos-level-number">Nivel 12</p>
          </div>
        </div>

        <!-- XP Progress Bar -->
        <div class="habitos-xp-container">
          <div class="habitos-xp-header">
            <span class="habitos-xp-label">Progreso del Roble</span>
            <span class="habitos-xp-value">750 / 1000 XP</span>
          </div>
          <div class="habitos-xp-bar">
            <div class="habitos-xp-fill"></div>
          </div>
        </div>
      </div>

      <div class="habitos-content">
        <div class="habitos-section-header">
          <h2 class="habitos-section-title">Objetivos de hoy</h2>
          <a href="habitos.html" class="habitos-view-all-link">Ver todo</a>
        </div>
        <div class="habitos-cards-container" id="habitsContainer">
          <p style="text-align: center; color: #666; width: 100%; padding: 20px;">Cargando hábitos...</p>
        </div>

        <!-- Bottom Spacer for Floating Button visibility -->
        <div class="habitos-add-container">
          <a href="anadirHabito.html" class="habitos-add-button">
            <span class="material-symbols-outlined">add_circle</span>
            <span>Añadir hábito</span>
          </a>
        </div>
      </div>
    </main>

    <!-- Floating Action Button -->

    <!-- Bottom Navigation Bar -->
    <nav class="habitos-nav">
      <div class="habitos-nav__container">
        <a class="habitos-nav__link" href="index.html">
          <span class="material-symbols-outlined habitos-nav__icon">home</span>
          <p class="habitos-nav__text">Inicio</p>
        </a>
        <a class="habitos-nav__link habitos-nav__link--active" href="habitos.html">
          <span class="material-symbols-outlined habitos-nav__icon habitos-nav__icon--filled">task_alt</span>
          <p class="habitos-nav__text">Hábitos</p>
        </a>
        <a class="habitos-nav__link" href="avatar.html">
          <span class="material-symbols-outlined habitos-nav__icon">park</span>
          <p class="habitos-nav__text">Avatar</p>
        </a>
        <a class="habitos-nav__link" href="tienda.html">
          <span class="material-symbols-outlined habitos-nav__icon">storefront</span>
          <p class="habitos-nav__text">Tienda</p>
        </a>
        <a class="habitos-nav__link" href="perfil.html">
          <span class="material-symbols-outlined habitos-nav__icon">person</span>
          <p class="habitos-nav__text">Perfil</p>
        </a>
      </div>
    </nav>
  </div>

  <script>
    // Funciones para manejar semillas
    function obtenerSemillas() {
      const semillas = localStorage.getItem('semillasUsuario');
      return semillas ? parseInt(semillas) : 500;
    }

    function guardarSemillas(cantidad) {
      localStorage.setItem('semillasUsuario', cantidad);
    }

    function agregarSemillas(cantidad) {
      const semillasActuales = obtenerSemillas();
      const nuevasSemillas = semillasActuales + cantidad;
      guardarSemillas(nuevasSemillas);
      return nuevasSemillas;
    }

    function restarSemillas(cantidad) {
      const semillasActuales = obtenerSemillas();
      const nuevasSemillas = Math.max(0, semillasActuales - cantidad);
      guardarSemillas(nuevasSemillas);
      return nuevasSemillas;
    }

    // Función para obtener la clave de la fecha de hoy
    function obtenerClaveFechaHoy() {
      const hoy = new Date();
      return `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
    }

    async function cargarHabitos() {
      try {
        const response = await fetchApi('/habits');
        const habitos = response.data || [];
        const container = document.getElementById('habitsContainer');
        container.innerHTML = '';

        if (habitos.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #666; width: 100%; padding: 20px;">No tienes hábitos todavía.</p>';
          return;
        }

        const hoy = obtenerClaveFechaHoy();

        habitos.forEach(habit => {
          // Verificar si ya está completado hoy viendo las completions
          const estaCompletadoHoy = habit.completions && habit.completions.some(c => c.completedAt.startsWith(hoy));

          const cardHtml = `
            <div class="habit-card">
              <div class="habit-card__icon-container habit-card__icon-container--primary" style="background: ${habit.color || '#e8f3e5'};">
                <span class="material-symbols-outlined" style="color: darken(${habit.color}, 20%);">${habit.icon || 'water_drop'}</span>
              </div>
              <div class="habit-card__content">
                <h3 class="habit-card__title">${habit.title}</h3>
                <p class="habit-card__category">${habit.description || 'General'}</p>
              </div>
              <label class="habit-checkbox">
                <input class="habit-checkbox__input" type="checkbox" data-habit-id="${habit.id}" ${estaCompletadoHoy ? 'checked disabled' : ''} />
                <div class="habit-checkbox__box" style="${estaCompletadoHoy ? 'background: #728764; border-color: #728764;' : ''}">
                  <span class="material-symbols-outlined habit-checkbox__icon" style="${estaCompletadoHoy ? 'opacity: 1; transform: scale(1);' : ''}">check</span>
                </div>
              </label>
            </div>
          `;
          container.insertAdjacentHTML('beforeend', cardHtml);
        });

        // Configurar los listeners
        document.querySelectorAll('.habit-checkbox__input:not(:disabled)').forEach(checkbox => {
          checkbox.addEventListener('change', async (e) => {
            const hId = e.target.getAttribute('data-habit-id');
            if (e.target.checked) {
              e.target.disabled = true; // Block further changes since we can't un-complete easily in this API version
              try {
                await fetchApi(`/habits/${hId}/completions`, { method: 'POST' });
                const semillasGanadas = 10;
                const totalSemillas = agregarSemillas(semillasGanadas);
                mostrarNotificacionSemillas(semillasGanadas, true);

                // Actualizar estilos para que parezca marcado permanentemente
                const box = e.target.nextElementSibling;
                box.style.background = '#728764';
                box.style.borderColor = '#728764';
                box.querySelector('span').style.opacity = '1';
                box.querySelector('span').style.transform = 'scale(1)';
              } catch (err) {
                e.target.checked = false;
                e.target.disabled = false;
                alert('Error al completar el hábito: ' + err.message);
              }
            }
          });
        });
      } catch (err) {
        document.getElementById('habitsContainer').innerHTML = '<p style="text-align: center; color: red;">Error al cargar hábitos.</p>';
      }
    }

    // Inicializar la carga cuando el script está listo
    window.addEventListener('DOMContentLoaded', () => {
      cargarHabitos();
    });

    // Agregar estilos para animaciones
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>

</html>